<html>
<head>
    <title>index</title>
    <script src="{{ STATIC_URL }}js/jquery-2.1.3.min.js"></script>
    <script src="{{ STATIC_URL }}js/Chart.min.js"></script>
    <script src="{{ STATIC_URL }}js/moment-with-locales.js"></script>
    {% load bootstrap3 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link href="{{ STATIC_URL }}css/site.css" media="all" rel="stylesheet">
    <script>
        // condense an array of arrays down to an array of numbers (averages)
        var aggregate = function(data) {
            var result = [];
            for(i = 0; i < data.length; i++) {
                if (data[i].length > 0) {
                    var sum = 0;
                    data[i].forEach(function(entry){
                        sum += entry;
                    });
                    result[i] = sum / data[i].length;
                }
                else if (i > 0) {
                    // if there is no value here, use the previous value
                    result[i] = result[i-1];
                }
                else {
                    // if there is still no value, just use 0 for this point
                    result[i] = 0;
                }
            }
            return result;
        }
        var intervalsAsLabels = function(intervals, aggregation) {
            var labels = [];
            for(i = intervals.length - 1; i >= 0; i--){
                if (i > 1) { labels.push(i + " " + aggregation + "s ago"); }
                else if (i == 1) {
                    // Second latest
                    if (aggregation != 'day') { labels.push("last " + aggregation); }
                    else { labels.push("yesterday"); }
                }
                else {
                    // Latest
                    if (aggregation != 'day') { labels.push("this " + aggregation); }
                    else { labels.push("today"); }
                }
            }
            return labels;
        }
        var body = new function() {
            this.divid = "body";
            this.aggregation = "week";
            this.chart = undefined;
            this.numIntervals = 7;
            this.refresh = function() {
                // Replace canvas to clear any previous gra
                $('#' + this.divid).replaceWith('<canvas id="' + this.divid + '"></canvas>');
                var ctx = $("#" + this.divid).get(0).getContext("2d");
                // Build labels for this week
                intervals = [];

                // Build intervals for this aggregation
                for(i = this.numIntervals - 1; i >= 0; i--) {
                    intervals.push(moment().subtract(i, this.aggregation));
                }
                // Build dataset
                dataset = {
                    label: "Weight",
                    fillColor: "rgba(0,0,220,0.6)",
                    strokeColor: "rgba(0,0,220,1)",
                    pointColor: "rgba(0,0,220,1)",
                    pointStrokeColor: "#fff",
                    pointHighlightFill: "#fff",
                    pointHighlightStroke: "rgba(0,0,220,0.6)",
                    data: [0,0,0,0,0,0,0]
                };
                var chart = new Chart(ctx).Line({
                    labels: intervalsAsLabels(intervals, this.aggregation),
                    datasets: [
                        dataset
                    ]
                },{scaleBeginAtZero: true});
                populateDataSet(chart, '/weight', this.aggregation, 0, intervals);
                $('#body-legend').html(chart.generateLegend());
            }
        }
        var updateChart = function(chart, dataset, data) {
            console.log("Setting chart dataset " + dataset + " to " + data);
            for (i = 0; i < data.length; i++) {
                chart.datasets[dataset].points[i].value = data[i];
            }
            chart.update();
        }
        var populateDataSet = function(chart, path, aggregation, datasetId, intervals) {
            console.log("Building chart from " + path);
            $.get(path, function(data, status){
                console.log(data);
                var rawEntries = [[],[],[],[],[],[],[]];
                data.forEach(function(entry){
                    for(i = 0; i <= rawEntries.length; i++) {
                        if (moment(entry["created"]).isAfter(intervals[i].startOf(aggregation))) {
                            if (moment(entry["created"]).isBefore(intervals[i].endOf(aggregation))) {
                                rawEntries[i].push(entry["value"]);
                                break;
                            }
                        }
                    }
                });
                datasetToAdd = aggregate(rawEntries);
                updateChart(chart, datasetId, datasetToAdd);
            });
        }
    </script>
</head>
<body>
    {# Display django.contrib.messages as Bootstrap alerts #}
    {% bootstrap_messages %}

    {% block bootstrap3_content %}
    <div class="container">
        <div id="body-panel" class="panel panel-info">
            <div class="panel-heading">
                Body
                <div class="pull-right btn-group btn-group-xs aggregation" role="group" aria-label="Aggregation">
                    <button type="button" class="btn btn-default" data-chart="body" data-aggregation="month">monthly</button>
                    <button type="button" class="btn btn-default" data-chart="body" data-aggregation="week">weekly</button>
                    <button type="button" class="btn btn-default" data-chart="body" data-aggregation="day">daily</button>
                </div>
            </div>
            <div class="panel-body">
                <canvas id="body"></canvas>
            </div>
            <div id="body-legend" class="panel-footer chart-legend"></div>
        </div>
    </div>
    <script>
        $(document).ready(function(){
            $("#body-panel > .panel-heading > [class*=aggregation] > [data-aggregation='week']").trigger('click');
        });
        $('.aggregation button').click(function(){
            console.log($(this).html());
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            window[this.dataset.chart].aggregation = this.dataset.aggregation;
            window[this.dataset.chart].refresh();
        });
    </script>
    {% endblock %}
</body>
