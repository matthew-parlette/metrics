<html>
<head>
    <title>index</title>
    <script src="{{ STATIC_URL }}js/jquery-2.1.3.min.js"></script>
    <script src="{{ STATIC_URL }}js/Chart.min.js"></script>
    <script src="{{ STATIC_URL }}js/moment-with-locales.js"></script>
    {% load bootstrap3 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link href="{{ STATIC_URL }}css/site.css" media="all" rel="stylesheet">
    <script>
        var aggregate = function(data) {

        }
    </script>
</head>
<body>
    {# Display django.contrib.messages as Bootstrap alerts #}
    {% bootstrap_messages %}

    {% block bootstrap3_content %}
    <div class="container">
        <div class="panel panel-info">
            <div class="panel-heading">
                Body
            </div>
            <div class="panel-body">
                <canvas id="body"></canvas>
            </div>
            <div id="body-legend" class="panel-footer chart-legend"></div>
        </div>
    </div>
    <script>
        $(document).ready(function(){
            var ctx = $("#body").get(0).getContext("2d");
            // Build labels for this week
            dates = [];
            weeks = [];
            labels = [];
            // Set strings for date formatting
            moment.locale('en', {
                calendar : {
                    lastDay : '[Yesterday]',
                    sameDay : '[This Week]',
                    nextDay : '[Tomorrow]',
                    lastWeek : '[Last Week]',
                    nextWeek : 'dddd',
                    sameElse : 'L',
                    sameWeek: '[This Week]'
                }
            });

            for(i = 6; i >= 0; i--){
                // dates.push(moment().subtract(i, 'days'));
                dates.push(moment().subtract(i, 'weeks'));
                if (i > 1) {
                    labels.push(i + " weeks ago");
                }
                else if (i == 1) {
                    labels.push("Last Week");
                }
                else {
                    labels.push("This Week");
                }
            }
            console.log("dates: " + dates);
            console.log("weeks: " + weeks);
            console.log("labels: " + labels);
            // Build dataset
            dataset = {
                label: "Weight",
                fillColor: "rgba(0,0,220,0.6)",
                strokeColor: "rgba(0,0,220,1)",
                pointColor: "rgba(0,0,220,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(0,0,220,0.6)",
                data: [0,0,0,0,0,0,0]
            };
            var bodyChart = new Chart(ctx).Line({
                labels: labels,
                datasets: [
                    dataset
                ]
            },{scaleBeginAtZero: true});
            $.get("/weight", function(data, status){
                console.log(data);
                var weekEntries = [[],[],[],[],[],[],[]];
                data.forEach(function(entry){
                    for(i = 0; i <= 6; i++) {
                        if (moment(entry["created"]).isAfter(dates[i].startOf('week'))) {
                            console.log(entry["created"] + " is after " + dates[i].startOf('week'));
                            if (moment(entry["created"]).isBefore(dates[i].endOf('week'))) {
                                console.log(entry["created"] + " is before " + dates[i].endOf('week'));
                                weekEntries[i].push(entry["value"]);
                                // bodyChart.addData([entry["value"]], labels[i]);
                                // bodyChart.update();
                                break;
                            }
                        }
                    }
                    //bodyChart.datasets[0].points[].value = entry["value"];
                    bodyChart.update();
                    console.log(bodyChart.generateLegend());
                    $('#body-legend').html(bodyChart.generateLegend());
                });
                console.log("weekEntries: " + weekEntries);
                for(i = 0; i <= 6; i++) {
                    if (weekEntries[i].length > 0) {
                        var sum = 0;
                        weekEntries[i].forEach(function(entry){
                            sum += entry;
                        });
                        bodyChart.datasets[0].points[i].value = sum / weekEntries[i].length;
                        bodyChart.update();
                    }
                }
            });
        });
    </script>
    {% endblock %}
</body>
