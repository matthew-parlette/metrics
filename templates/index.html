<html>
<head>
    <title>index</title>
    <script src="{{ STATIC_URL }}js/jquery-2.1.3.min.js"></script>
    <script src="{{ STATIC_URL }}js/Chart.min.js"></script>
    <script src="{{ STATIC_URL }}js/moment-with-locales.js"></script>
    {% load bootstrap3 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link href="{{ STATIC_URL }}css/site.css" media="all" rel="stylesheet">
    <script>
        // condense an array of arrays down to an array of numbers (averages)
        var aggregate = function(data) {
            var result = [];
            for(i = 0; i < data.length; i++) {
                if (data[i].length > 0) {
                    var sum = 0;
                    data[i].forEach(function(entry){
                        sum += entry;
                    });
                    result[i] = sum / data[i].length;
                }
                else if (i > 0) {
                    // if there is no value here, use the previous value
                    result[i] = result[i-1];
                }
                else {
                    // if there is still no value, just use 0 for this point
                    result[i] = 0;
                }
            }
            return result;
        }
        var updateChart = function(chart, dataset, data) {
            console.log("Setting chart dataset " + dataset + " to " + data);
            for (i = 0; i < data.length; i++) {
                chart.datasets[dataset].points[i].value = data[i];
            }
            chart.update();
        }
        var populateDataSet = function(chart, path, aggregation, datasetId) {
            console.log("Building chart from " + path);
            $.get(path, function(data, status){
                console.log(data);
                var rawEntries = [[],[],[],[],[],[],[]];
                data.forEach(function(entry){
                    for(i = 0; i <= rawEntries.length; i++) {
                        if (moment(entry["created"]).isAfter(dates[i].startOf(aggregation))) {
                            if (moment(entry["created"]).isBefore(dates[i].endOf(aggregation))) {
                                rawEntries[i].push(entry["value"]);
                                break;
                            }
                        }
                    }
                });
                datasetToAdd = aggregate(rawEntries);
                updateChart(chart, datasetId, datasetToAdd);
            });
        }
    </script>
</head>
<body>
    {# Display django.contrib.messages as Bootstrap alerts #}
    {% bootstrap_messages %}

    {% block bootstrap3_content %}
    <div class="container">
        <div id="body-panel" class="panel panel-info">
            <div class="panel-heading">
                Body
                <div class="pull-right btn-group btn-group-xs aggregation" role="group" aria-label="Aggregation">
                    <button type="button" class="btn btn-default" data-chart="body" data-aggregation="month">monthly</button>
                    <button type="button" class="btn btn-default" data-chart="body" data-aggregation="week">weekly</button>
                    <button type="button" class="btn btn-default" data-chart="body" data-aggregation="day">daily</button>
                </div>
            </div>
            <div class="panel-body">
                <canvas id="body"></canvas>
            </div>
            <div id="body-legend" class="panel-footer chart-legend"></div>
        </div>
    </div>
    <script>
        $(document).ready(function(){
            $("#body-panel > .panel-heading > [class*=aggregation] > [data-aggregation='week']").trigger('click');
        });
        $('.aggregation button').click(function(){
            console.log($(this).html());
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            var ctx = $("#" + this.dataset.chart).get(0).getContext("2d");
            // Build labels for this week
            dates = [];
            weeks = [];
            labels = [];

            for(i = 6; i >= 0; i--){
                // dates.push(moment().subtract(i, 'days'));
                dates.push(moment().subtract(i, this.dataset.aggregation));
                if (i > 1) {
                    labels.push(i + " " + this.dataset.aggregation + "s ago");
                }
                else if (i == 1) {
                    if (this.dataset.aggregation != 'day') {
                        labels.push("last " + this.dataset.aggregation);
                    }
                    else{ labels.push("today"); }
                }
                else { labels.push("this " + this.dataset.aggregation); }
            }
            // Build dataset
            dataset = {
                label: "Weight",
                fillColor: "rgba(0,0,220,0.6)",
                strokeColor: "rgba(0,0,220,1)",
                pointColor: "rgba(0,0,220,1)",
                pointStrokeColor: "#fff",
                pointHighlightFill: "#fff",
                pointHighlightStroke: "rgba(0,0,220,0.6)",
                data: [0,0,0,0,0,0,0]
            };
            var bodyChart = new Chart(ctx).Line({
                labels: labels,
                datasets: [
                    dataset
                ]
            },{scaleBeginAtZero: true});
            populateDataSet(bodyChart, '/weight', this.dataset.aggregation, 0);
            $('#body-legend').html(bodyChart.generateLegend());
        });
    </script>
    {% endblock %}
</body>
